#summary Configuring email for alerting and reporting
= Introduction =

This page describes how to configure email for alerting and reporting.  Applications such as Snorby, Sguil, and OSSEC have their own mail configuration and don't rely on a mail server in the OS itself.  However, you may still want to install a mail server in the OS so that you can get daily emails from the sostat script and from Bro.

= How do I configure Snorby to send emails? =
Modify Snorby's mail_config.rb file on the master server as needed for your mail server:
{{{
# Security Onion 12.04
/opt/snorby/config/initializers/mail_config.rb

# Security Onion 10.04
/usr/local/share/snorby/config/initializers/mail_config.rb
}}}
Then restart the Snorby delayed_job process:
{{{
sudo pkill -f delayed_job

# Security Onion 12.04
sudo su www-data -c "cd /opt/snorby; bundle exec rake snorby:update RAILS_ENV=production"

# Security Onion 10.04
sudo su www-data -c "cd /usr/local/share/snorby; bundle exec rake snorby:update RAILS_ENV=production"
}}}
You can also modify snorby_config.yml (Security Onion 12.04 - /opt/snorby/config/snorby_config.yml | Security Onion 10.04 - /usr/local/share/snorby/config/snorby_config.yml) and change the "domain" setting in the Production section to be the FQDN or IP address of your Snorby server.  However, the resulting link in the email will still be incorrect since it will be http instead of https and it will be missing the port 3000 designation.

= How do I configure Sguil to send alerts via email?<br> =
Modify /etc/nsm/securityonion/sguild.email (on the master server) as needed and restart sguild:
{{{
sudo nsm_server_ps-restart
}}}
You can then verify the email configuration by looking at the top of sguild's log file:
{{{
head -20 /var/log/nsm/securityonion/sguild.log
}}}
For more information, please see:<br>
<a href="http://nsmwiki.org/Sguil_FAQ#Can_sguil_page_me_when_it_sees_a_particular_alert.3F">http://nsmwiki.org/Sguil_FAQ#Can_sguil_page_me_when_it_sees_a_particular_alert.3F</a>

= How do I configure OSSEC to send emails? =
Modify /var/ossec/etc/ossec.conf as follows:
{{{
  <global>
    <email_notification>yes</email_notification>
    <email_to>YourUsername@YourDomain.com</email_to>
    <smtp_server>YourMailRelay.YourDomain.com</smtp_server>
    <email_from>ossec@YourDomain.com</email_from>
    <email_maxperhour>100</email_maxperhour>
  </global>
}}}
Then restart OSSEC:
{{{
# Security Onion 12.04
sudo service ossec-hids-server restart

# Security Onion 10.04
sudo service ossec restart
}}}

= How do I configure the OS itself to send emails? =
Install and configure your favorite mail server.  Depending on your needs, this could be something simple like nullmailer (recommended) or something more complex like exim4.

Here are some nullmailer instructions provided by Michael Iverson:
{{{
sudo apt-get install nullmailer
# edit /etc/mailname to hold your "from" domain name. (If you were google, you'd use "gmail.com".)
# edit /etc/nullmailer/adminaddr to contain the address you want mail to root to be routed to.
# edit /etc/nullmailer/remotes to contain the mail server to forward email to. 
}}}
Alternatively, here are some instructions for the more complex exim4:
{{{
sudo apt-get -y install mailutils
sudo dpkg-reconfigure exim4-config
}}}
Once you've configured your mail server and verified that it can send email properly, you might want to create a daily cronjob to execute /usr/bin/sostat and email you the output:
{{{
# /etc/cron.d/sostat
#
# crontab entry to run sostat and email its output

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
EMAIL=YourUsername@YourDomain.com

01 12    * * *   root    HOSTNAME=`hostname`; /usr/bin/sostat | mail -s "$HOSTNAME stats" $EMAIL
}}}

= How do I configure Bro to send emails? =
Edit broctl.cfg (Security Onion 12.04 - /opt/bro/etc/broctl.cfg | Security Onion 10.04 - /usr/local/etc/broctl.cfg) and set the following:
{{{
MailTo = YourUsername@YourDomain.com
sendmail = /usr/sbin/sendmail
}}}
Then update and restart Bro:
{{{
sudo broctl install && sudo broctl restart
}}}

You should then start receiving hourly connection summary emails.  If you don't want the connection summary emails, you can add the following to broctl.cfg:
{{{
tracesummary=
}}}
(Don't forget to update and restart Bro as shown above.)

You may want to receive emails for Bro notices.  To do that, uncomment the following line in local.bro (Security Onion 12.04 - /opt/bro/share/bro/site/local.bro | Security Onion 10.04 - /usr/local/share/bro/site/local.bro:
{{{
# redef Notice::policy += { [$action = Notice::ACTION_ALARM, $priority = 0] };
}}}
(Don't forget to update and restart Bro as shown above.)  If that's too much email, you might want to comment out that line again and instead only email selected notices by placing the following at the *very bottom (after all the @load statements)* like this:
{{{
redef Notice::emailed_types += {
       HTTP::Incorrect_File_Type,
       HTTP::SQL_Injection_Victim,
       SSH::Interesting_Hostname_Login,
       HTTP::Malware_Hash_Registry_Match,
};
}}}

= How can I get an email alert when my sensor stops seeing traffic? =
If you configured Bro as shown above, it should automatically do this for you.  More options can be found on the [SensorStopsSeeingTraffic] page.