#summary Security Onion 12.04 Installation Procedure

= Introduction =
*Welcome to the Security Onion Installation Guide!*

To install Security Onion, you're going to either install our Security Onion ISO image *or* install a standard Ubuntu 12.04 ISO image and then add our Security Onion PPA and packages.  

= ALWAYS verify the checksum of ANY downloaded ISO image = 
Regardless of whether you're downloading our Security Onion ISO image or whether you're starting with an Ubuntu 12.04 ISO image, you should ALWAYS verify the checksum of the downloaded ISO image.  
  * If downloading our Security Onion ISO image, you can download the accompanying .md5 file or you can use the MD5/SHA1 checksums that Sourceforge displays when clicking the Information (view details) button to the right of the ISO image (it's a circle with an "i").
  * If downloading an Ubuntu 12.04 ISO image, use the accompanying .md5 file.
Here are some Ubuntu instructions for verifying checksums:
https://help.ubuntu.com/community/HowToMD5SUM

= Overview = 
This Installation Guide consists of four different methods of installation:
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#What's_the_QUICKEST_way_to_install_Security_Onion?">QUICKEST Method</a>
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#If_you_just_want_to_quickly_evaluate_Security_Onion,_use_our_ISO">RECOMMENDED Method for QUICKLY EVALUATING Security Onion using the SECURITY ONION ISO image</a>
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#If_you_want_to_quickly_evaluate_Security_Onion_on_your_preferred">RECOMMENDED Method for QUICKLY EVALUATING Security Onion using YOUR PREFERRED FLAVOR OF UBUNTU 12.04</a>
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#If_you're_going_to_be_deploying_Security_Onion_in_productio">RECOMMENDED Method for PRODUCTION DEPLOYMENT</a>

After installing using one of the four methods listed above, you'll want to review some of the sections at the bottom of this page:
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#ELSA_and_timezones">ELSA_and_Timezones</a>
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#CapME">CapMe</a>
  * <a href="https://code.google.com/p/security-onion/wiki/Installation#Tuning_/_Miscellaneous">Tuning/Miscellaneous</a>

= UEFI =
If you have a new machine with UEFI, please see:
https://help.ubuntu.com/community/UEFI

= Ubuntu 12.04 =
If you're going to be installing your own version of Ubuntu and then adding our PPA and packages, please remember that our PPA and packages are only compatible with Ubuntu 12.04.

= What's the QUICKEST way to install Security Onion? =
  # Download our ISO image (based on Xubuntu 12.04 64-bit) from <a href="https://sourceforge.net/projects/security-onion/files/12.04.4/">Sourceforge</a> or via <a href="http://port111.com/securityonion-12.04.4-20140222.iso.torrent">Torrent</a> and verify the checksum using the checksums provided on the Sourceforge page.
  # Boot the ISO image, follow the prompts in the Xubuntu installer to install to your hard drive, and then reboot into your new installation.
  # Double-click the Setup wizard on the Desktop and follow the prompts.

= What's the RECOMMENDED procedure for installing Security Onion? =

== If you just want to quickly evaluate Security Onion, use our ISO image (based on Xubuntu 12.04 64-bit): ==
  # First, check the [Hardware Hardware Requirements] page.
  # Click the following link: https://sourceforge.net/projects/security-onion/files/12.04.4/
  # Download/record the MD5/SHA1 checksums for the ISO image. You can download the .md5 file or you can use the MD5/SHA1 checksums that Sourceforge displays when clicking the Information (view details) button to the right of the ISO image (it's a circle with an "i").
  # Download the ISO image from that Sourceforge page or via <a href="http://port111.com/securityonion-12.04.4-20140222.iso.torrent">Torrent</a>.
  # Once the ISO image download has completed, verify the checksum.
  # Boot the ISO image into the Live Desktop environment and then double-click the Install icon on the desktop.
  # Follow the prompts in the Xubuntu installer.  If prompted with an "encrypt home folder" option, DO NOT enable this feature.  If asked about automatic updates, DO NOT enable automatic updates.  Reboot into your new installation.  Login using the username/password you specified during installation.
  # Verify that you have Internet connectivity.  If necessary, configure your [Proxy proxy settings].
  # [Upgrade Install updates and reboot.]
  # Double-click the Setup icon.  The Setup wizard will walk you through configuring /etc/network/interfaces and will then reboot.
  # After rebooting, log back in and start the Setup wizard again.  It will detect that you have already configured /etc/network/interfaces and will walk you through the rest of the configuration.
  # Once you've completed the Setup wizard, use the Desktop icons to login to Sguil, Squert, Snorby, or ELSA.
<br>
== If you want to quickly evaluate Security Onion on your preferred flavor of Ubuntu 12.04 32-bit/64-bit (not using our ISO image), follow these steps: ==
  # First, check the [Hardware Hardware Requirements] page.
  # Download the ISO image for your prefered flavor of Ubuntu *12.04*, verify its checksum,  and boot from it.<br>
  # Follow the prompts in the installer.  If prompted with an "encrypt home folder" option, DO NOT enable this feature.  If asked about automatic updates, DO NOT enable automatic updates.  Reboot into your new installation.
  # Login using the username/password you specified during installation.
  # Verify that you have Internet connectivity.  If necessary, configure your [Proxy proxy settings].
  # If you used an Ubuntu 12.04 release after 12.04.3, then you may have an incompatible kernel.  Ubuntu 12.04.4 ships with kernel 3.11 which is not compatible with our current version of PF_RING.  You'll need to install the older 3.8 kernel packages (including headers) and remove 3.11.
  # Install all Ubuntu updates and reboot.
  # Log back in (using “ssh -X” if you’re installing on Ubuntu Server or a headless distro).<br>
  # Configure MySQL not to prompt for root password:<br>
{{{
echo "debconf debconf/frontend select noninteractive" | sudo debconf-set-selections
}}}
  # Add the Security Onion stable repository:<br>
{{{
sudo apt-get -y install python-software-properties
sudo add-apt-repository -y ppa:securityonion/stable
sudo apt-get update
}}}
  # Install the securityonion-all metapackage:<br>
{{{
sudo apt-get -y install securityonion-all
}}}
  # Run the Setup wizard:<br>
{{{
sudo sosetup
}}}
  # Follow the prompts.<br>
  # Analyze alerts using the Sguil client, or open a browser to https://localhost where you can access Squert, Snorby, and ELSA.<br>
<br>
== If you're going to be deploying Security Onion in production, follow these steps:==
  # First, check the [Hardware Hardware Requirements] page.
  # Download the ISO image for your prefered flavor of Ubuntu *12.04* 32-bit/*64-bit* or download our Security Onion ISO image using the instructions above. Also download/record the MD5/SHA1 checksums for the ISO image and verify the checksum when the download has completed.<br>
  # If deploying a distributed environment (a master server and one or more slave sensors), you’ll need to perform the remaining steps on the server and all sensors, but make sure you install/configure the master server first.  Please note that sensors need to connect to the master server on ports 22 and 7736.  If you choose to enable salt for sensor management, they will also need to be able to connect to the master server on ports 4505 and 4506.<br>
  # Using the downloaded ISO, install the operating system. If prompted with an "encrypt home folder" option, DO NOT enable this feature.  If asked about automatic updates, DO NOT enable automatic updates.  If prompted to install any additional packages, the only option you should choose is OpenSSH Server (openssh-server). Specifically, do NOT choose MySQL. All other required dependencies will be installed automatically.<br>
  # When asked about partitioning, there are a few things to keep in mind:
   * If you have more than 2TB of disk space, you will probably want to create a dedicated /boot partition at the beginning of the disk to ensure that you don’t have any Grub booting issues.
   * The Sguil database on the server (doesn’t exist on sensor-only installations) can grow fairly large (100GB or more for decent-size networks). It’s stored at /var/lib/mysql/, so you may want to put /var on a dedicated partition/disk and assign a good amount of disk space to it. Also see the DAYSTOKEEP instructions near the end of this procedure.
   * Sensors store full packet captures at /nsm/sensor_data/, so you may want to put /nsm on a dedicated partition/disk and assign as much disk space as possible (1TB or more). For larger volumes you might also consider using XFS for the /nsm partition.
  # When installation completes, reboot into your new installation and login with the credentials you specified during installation.<br>
  # If you’re running a VM, now would be a good time to snapshot it so you can revert later if you need to.<br>
  # If you installed from the Security Onion Live 12.04 Distribution ISO, run "sudo soup", reboot if prompted, and then skip to the "Setup wizard" step below.<br>
  # If your machine is running a 32 bit version of Ubuntu and you have more than 4GB of RAM, <a href="https://help.ubuntu.com/community/EnablingPAE">install the PAE kernel</a>.<br>
  # If you used an Ubuntu release after 12.04.3, then you may have an incompatible kernel.  12.04.4 ships with kernel 3.11 which is not compatible with our current version of PF_RING.  You'll need to install the older 3.8 kernel packages (including headers) and remove 3.11.
  # Install all Ubuntu updates and reboot.
  # Log back in (over “ssh -X” if remote) and configure MySQL not to prompt for root password:<br>
{{{
echo "debconf debconf/frontend select noninteractive" | sudo debconf-set-selections
}}}
    * If using “-X”, Once logged in, you may get a message concerning the .Xauthority file. This file should be created automatically, but if it doesn't (occasionally this has happened on AWS instances), you can create it manually:
{{{
touch ~/.Xauthority
}}}
  # Install python-software-properties if it's not already installed:<br>
{{{
sudo apt-get -y install python-software-properties
}}}
  # Add the Security Onion stable repository:<br>
{{{
sudo add-apt-repository -y ppa:securityonion/stable
}}}
  # If you got a ValueError when running the previous command, please see the following note from jonh; otherwise, continue to the next step.  "when I did the {{{add-apt-repository -y ppa:securityonion/stable}}} command it gave a bunch of lines of errors with the final line being {{{ValueError: cannot convert float NaN to integer}}}. This appears to be a known bug: <a href="https://bugs.launchpad.net/ubuntu/+source/software-properties/+bug/1063350">https://bugs.launchpad.net/ubuntu/+source/software-properties/+bug/1063350</a>. The reported workaround of downgrading python-software-properties got me past that error."
{{{
# Only run this if you got a ValueError in the previous step!
sudo apt-get install python-software-properties=0.82.7
}}}
  # Update:<br>
{{{
sudo apt-get update
}}}
  # Install the securityonion-all metapackage (or one of the more focused metapackages from the list below). This could take 15 minutes or more depending on the speed of your CPU and Internet connection.<br>
{{{
sudo apt-get -y install securityonion-all
}}}
  # OPTIONAL: If you want to use Salt to manage your deployment, also install securityonion-onionsalt.  You can do this before or after Setup, but it's much easier if you do it before Setup. https://code.google.com/p/security-onion/wiki/Salt<br>
{{{
sudo apt-get -y install securityonion-onionsalt
}}}
  # Run the Setup wizard (if you get a zenity Gtk-WARNING, then you need to make sure you used "ssh -X" to enable X-Forwarding):<br>
{{{
sudo sosetup
}}}
  # The Setup wizard will walk you through configuring /etc/network/interfaces and will then reboot.<br>
   * When prompted whether you would like to configure /etc/network/interfaces now, choose “Yes, configure /etc/network/interfaces!.”
   * If you have more than one network interface, you’ll be asked which to specify which one should be the management interface.
   * You’ll then be asked to choose DHCP or static addressing for the management interface. It is highly recommended you choose static.
   * Choosing static, you’ll be prompted to enter a static IP address for your management interface, the network’s subnet mask, gateway IP address, DNS server IP addresses (separated by spaces), and your local domain.
   * You’ll then be prompted to select any additional interfaces that will be used for sniffing/monitoring network traffic.
   * When prompted, choose “Yes, make changes and reboot!”
  # After rebooting, log back in (over “ssh -X” if remote) and start the Setup wizard again (sudo sosetup). It will detect that you have already configured /etc/network/interfaces and will walk you through the rest of the configuration.<br>
  # Select Advanced Setup.<br>
  # Choose whether the host being configured will be Standalone, Server, or Sensor.<br>
   * Standalone
    * You will be prompted to specify which IDS Engine (Snort or Suricata) you would like to use.
    * If you have multiple CPU cores available:
     * You will be prompted to designate how many IDS processes you would like to run. (This setting can be modified later by changing the IDS_LB_PROCS variable in /etc/nsm/HOSTNAME-INTERFACE/sensor.conf).
     * You will be prompted to designate how many Bro processes you would like to run. (This setting can be modified later by changing the lb_procs variable in /opt/bro/etc/node.cfg).
    * You’ll be asked which IDS ruleset you would like to use.
    * You will then be prompted for user account information for Sguil, Squert, ELSA and Snorby.
    * You’ll be asked whether you want to enable ELSA.
    * You’ll be prompted to proceed with making the changes to setup Security Onion.
   * Server
    * You will be prompted to specify which IDS Engine (Snort or Suricata) you would like to use.
    * If you have multiple CPU cores available:
     * You will be prompted to designate how many IDS processes you would like to run. (This setting can be modified later by changing the IDS_LB_PROCS variable in /etc/nsm/HOSTNAME-INTERFACE/sensor.conf).
     * You will be prompted to designate how many Bro processes you would like to run. (This setting can be modified later by changing the lb_procs variable in /opt/bro/etc/node.cfg).
    * You’ll be asked which IDS ruleset you would like to use.
    * You will then be prompted for user account information for Sguil, Squert, ELSA and Snorby.
    * You’ll be asked whether you want to enable ELSA.
    * You’ll be prompted to proceed with making the changes to setup Security Onion.
   * Sensor
    * You will be prompted for an SSH account on the master server that has sudo privileges. (Note: the management interface on the sensor must be able to SSH to the management interface on the server, so please make sure that your server has been set up and you have network connectivity and no firewall rules that would block this traffic.) Consider creating a separate SSH account on the master server for each sensor so that if a sensor is ever compromised, its individual account can be disabled without affecting the other sensors. To do this, create a new user using the adduser command and then add the user to the sudo group. Once Setup is complete, the user can be removed from the sudo group. For example, suppose you’re setting up a server and two separate sensors:
     * SERVER
      * run through sosetup
     * FIRST SENSOR
      * create an account on the SERVER and add it to the sudo group
      * run through sosetup on the SENSOR
      * on the SERVER, remove the account from the sudo group, but leave the account active
     * SECOND SENSOR
      * create a second account on the SERVER and add it to the sudo group
      * run through SETUP on the second SENSOR
      * on the SERVER, remove the account from the sudo group, but leave the account active
    * You’ll be asked which network interface should be monitored.
    * If you have multiple CPU cores available:
     * You will be prompted to designate how many IDS processes you would like to run. (This setting can be modified later by changing the IDS_LB_PROCS variable in /etc/nsm/HOSTNAME-INTERFACE/sensor.conf).
     * You will be prompted to designate how many Bro processes you would like to run. (This setting can be modified later by changing the lb_procs variable in /opt/bro/etc/node.cfg).
    * You’ll be asked whether you want to enable ELSA. (ELSA is a distributed log archiving platform, so each sensor’s events stored in ELSA will be stored locally at each sensor and queried from the server which acts as a central interface.)

= Metapackages =
The instructions above used the securityonion-all metapackage to install ALL of our individual packages (about 350MB).  We have some more focused metapackages that you can use for a more focused deployment:
  * securityonion-client (about 50MB)
  * securityonion-sensor (about 50MB)
  * securityonion-elsa and securityonion-elsa-extras (about 50MB)
  * securityonion-server (about 200MB)

= ELSA and timezones =

By default, ELSA will display timestamps in the timezone of your local browser.  You can force ELSA to always display timestamps in UTC by configuring the use_utc setting in your ELSA Preferences panel:

1. Navigate to ELSA -> Preferences: 

[http://security-onion.googlecode.com/svn/wiki/images/elsa/elsa_prefs.png]

2. Select Actions -> Add New Preference: 

[http://security-onion.googlecode.com/svn/wiki/images/elsa/elsa_prefs_add.png]

3. Enter the following into the new Preference: 
{{{
Type = default_settings
Name = use_utc
Value = 1
}}}
[http://security-onion.googlecode.com/svn/wiki/images/elsa/elsa_prefs_utc.png]

= CapME =
Our Setup script automatically configures both Snorby and ELSA to be able to pivot to CapME for full transcripts.  The CapME page will prompt you for username/password and you will enter your normal Sguil/Squert/ELSA username/password.  You have the option of automatically authenticating, but be aware that this will send your username/password in the GET request, so it will be displayed in the browser bar in plaintext.

== Configuring Snorby to auto-authenticate to CapME ==
  * Click "Administration and General Settings".
  * Under OpenFPC, select "Packet capture auto-authenticate" and enter your *Sguil* username and password.
  * Click "Save Settings".

== Configuring ELSA to auto-authenticate to CapME ==
  * Click the ELSA menu and click Preferences.
  * Create a new Preference called "openfpc_username" and enter your *Sguil* username.
  * Create a new Preference called "openfpc_password" and enter your *Sguil* password.
  * Close the Preferences window and reload the ELSA page.

= Tuning / Miscellaneous =
  # If you’re monitoring IP address ranges other than private RFC1918 address space (192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12), you should update your sensor configuration with the correct IP ranges. Sensor configuration files can be found in /etc/nsm/HOSTNAME-INTERFACE/. Modify either snort.conf or suricata.yaml (depending on which IDS engine you chose during sosetup) and update the HOME_NET variable. Also update the home_nets variable in prads.conf. Then update Bro’s network configuration in /opt/bro/etc/networks.cfg.<br>
  # Restart the sensor processes:<br>
{{{
sudo nsm_sensor_ps-restart
}}}
  # If you have Internet access, create an IDS alert by typing the following at a terminal:<br>
{{{
curl http://testmyids.com
}}}
  # Full-time analysts should run Security Onion in a VM on their workstation, then launch the Sguil client and connect to the IP/hostname of their production Sguil sensor. This allows you to investigate pcaps without fear of impacting your production server/sensors. If you're using ELSA, you may want to install the Google Chrome browser (in addition to the already included Chromium) since it includes Flash needed to display the inline Flash charts.  To change the resolution of your Security Onion VM, install the Virtual Tools for your virtualization solution or use xrandr. For a list of available screen resolutions, simply execute “xrandr”. To set the screen resolution (replace W and H with the actual Width and Height desired):<br>
{{{
xrandr -s WxH
}}}
  # Login to Sguil and review your IDS alerts. Squert, Snorby and ELSA can be accessed by visiting https://server/ for additional in-depth analysis.<br>
  # Be aware that Snorby uses highcharts. Read the <a href="http://shop.highsoft.com/highcharts.html">highcharts license</a> to determine if you need to purchase a commercial license. If you feel that you would be required to purchase a commercial license but are unwilling/unable to, you can <a href="http://code.google.com/p/security-onion/wiki/FAQ#How_do_I_disable_Snorby?">disable/remove Snorby altogether</a> or de-activate HighCharts (the charts on the bottom half of the Snorby Dashboard will be blank, but nothing else in Snorby should be affected):
{{{
sudo mv /opt/snorby/public/javascripts/highcharts.js /opt/snorby/public/javascripts/highcharts.js.DISABLED
}}}
  # Harden your server and sensors by disabling any unneeded services and <a href="http://code.google.com/p/security-onion/wiki/Firewall">firewalling</a> off any unused ports.<br>
  # Run the following to see how your sensor is coping with the load. You should check this on a daily basis to make sure your sensor is not dropping packets. Consider adding it to a cronjob and having it emailed to you (see the “configure email” link below).<br>
{{{
sudo sostat | less
}}}
  # Please note that any IDS/NSM system needs to be tuned for the network it’s monitoring. Please see <a href="http://code.google.com/p/security-onion/wiki/ManagingAlerts">ManagingAlerts</a>. You should only run the signatures you really care about.<br>
  # Also note that you should be looking at and categorizing events every day with the goal being to categorize all events every day. Even if you don’t use the Sguil console for your primary analysis, you need to log into it periodically and F8 old events to keep the real time queue from getting too big. Neglecting to do so will result in database/Sguil issues as the number of uncategorized events continues to increase on a daily basis. Please see the <a href="http://nsmwiki.org/Sguil_Client">Sguil client page on NSMwiki</a>.<br>
  # On the server running the Sguil database, set the DAYSTOKEEP variable in /etc/nsm/securityonion.conf to however many days you want to keep in your archive. The default is 365, but you may need to adjust it based on your organization’s detection/response policy and your available disk space.<br>
  # You should also tune <a href="http://code.google.com/p/security-onion/wiki/http_agent">http_agent</a>.  If you're running ELSA, you already have all the Bro HTTP logs available there, so you might want to disable http_agent to avoid duplicating those logs in the Sguil database (note the NSM scripts will then show http_agent as failed):
{{{
# Terminate the running http_agent
sudo nsm_sensor_ps-stop --only-http-agent
# Disable http_agent
sudo sed -i 's|HTTP_AGENT_ENABLED="yes"|HTTP_AGENT_ENABLED="no"|g' /etc/nsm/*/sensor.conf
}}}
  # Disable any unneeded sensor processes: <a href="http://blog.securityonion.net/2013/07/new-nsm-and-setup-packages-allow-you-to.html">http://blog.securityonion.net/2013/07/new-nsm-and-setup-packages-allow-you-to.html</a><br>
  # Tune the number of PF_RING instances for Snort/Suricata and Bro: [PF_RING]
  # Optional: exclude unnecessary traffic from your monitoring using <a href="http://code.google.com/p/security-onion/wiki/BPF">BPF</a>.<br>
  # Optional: add new Sguil user accounts with the following:<br>
{{{
sudo nsm_server_user-add
}}}
  # Optional, but highly recommended: configure [Email email] for alerting and reporting.
  # Optional: need “remote desktop” access to your Security Onion sensor or server?  We recommend SSH X-Forwarding as shown above, but if you want something more rdp-like, you can install <a href="http://www.xrdp.org/">xrdp</a> (sudo apt-get install xrdp) or <a href="http://code.google.com/p/security-onion/wiki/FreeNX">FreeNX</a>.  Please note that we do not support xrdp or FreeNX.
  # Read more about the tools contained in Security Onion: <a href="http://code.google.com/p/security-onion/wiki/Tools">Tools</a> 
  # Refer back to this document often, as it is updated quite regularly.